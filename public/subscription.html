<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Subscription & Billing - Dikoora</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #1a1a2e;
        }

        /* Navigation */
        nav {
            background: white;
            padding: 0 40px;
            height: 70px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo img {
            height: 60px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 32px;
        }

        .nav-links a {
            text-decoration: none;
            color: #4b5563;
            font-weight: 500;
            font-size: 15px;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: #2563eb;
        }

        .nav-links a.active {
            color: #2563eb;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            margin-bottom: 8px;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
        }

        .page-header p {
            color: #6b7280;
            margin-top: 4px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 24px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #2563eb;
        }

        .back-link svg {
            width: 18px;
            height: 18px;
        }

        /* Grid Layout */
        .billing-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
            margin-top: 32px;
        }

        .main-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .side-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h3 svg {
            width: 20px;
            height: 20px;
            color: #2563eb;
        }

        .card-body {
            padding: 24px;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-badge.canceled {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Current Plan Card */
        .current-plan-card {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
            border: none;
        }

        .current-plan-card.free {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }

        .current-plan-card .card-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-plan-card .card-header h3 {
            color: white;
        }

        .current-plan-card .card-header h3 svg {
            color: rgba(255, 255, 255, 0.9);
        }

        .current-plan-card .status-badge.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .current-plan-card .card-body {
            color: white;
        }

        .plan-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .plan-info h4 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .plan-info .plan-name {
            font-size: 28px;
            font-weight: 700;
        }

        .plan-info .plan-price {
            font-size: 15px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .renewal-info h4 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 4px;
            text-align: right;
        }

        .renewal-date {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .renewal-date svg {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }

        .plan-actions {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Usage Analytics */
        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .usage-header span {
            font-size: 12px;
            color: #6b7280;
        }

        .usage-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .usage-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }

        .usage-chart {
            height: 200px;
            background: linear-gradient(to top, rgba(37, 99, 235, 0.03), transparent);
            border-radius: 12px;
            position: relative;
            overflow: visible;
            padding: 20px 20px 10px 20px;
        }

        .line-chart-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .line-chart-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .chart-line {
            fill: none;
            stroke: url(#lineGradient);
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3));
        }

        .chart-area {
            fill: url(#areaGradient);
            opacity: 0.3;
        }

        .chart-point {
            fill: white;
            stroke: #2563eb;
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.2s ease;
            filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.2));
        }

        .chart-point:hover {
            r: 8;
            stroke-width: 4;
            stroke: #7c3aed;
        }

        .chart-point-hitarea {
            fill: transparent;
            cursor: pointer;
        }

        .chart-grid-line {
            stroke: #e5e7eb;
            stroke-width: 1;
            stroke-dasharray: 4 4;
        }

        .chart-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transform: translateX(-50%) translateY(-10px);
            transition: all 0.2s ease;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chart-tooltip.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .chart-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #334155;
        }

        .tooltip-value {
            font-size: 18px;
            font-weight: 700;
            color: #60a5fa;
        }

        .tooltip-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            padding: 12px 20px 0 20px;
        }

        .chart-labels span {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .chart-y-labels {
            position: absolute;
            left: 0;
            top: 20px;
            bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-right: 8px;
        }

        .chart-y-labels span {
            font-size: 10px;
            color: #9ca3af;
            text-align: right;
        }

        .chart-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
        }

        .chart-empty-state svg {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .chart-empty-state p {
            font-size: 13px;
        }

        /* Payment Method Card */
        .payment-method {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .payment-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 48px;
            height: 32px;
            background: #1e293b;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-details .card-brand {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .card-details .card-expiry {
            font-size: 12px;
            color: #6b7280;
        }

        .btn-edit {
            background: none;
            border: none;
            color: #2563eb;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .btn-edit:hover {
            background: #eff6ff;
        }

        .btn-add-payment {
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-payment:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        /* Promo Card */
        .promo-card {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .promo-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            filter: blur(20px);
        }

        .promo-card .card-body {
            position: relative;
            z-index: 1;
        }

        .promo-card h3 {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .promo-card p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .btn-contact {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            color: #1e40af;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-contact:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }

        /* Available Plans */
        .plans-section {
            margin-top: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: #111827;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .plan-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
            position: relative;
        }

        .plan-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
        }

        .plan-card.current {
            border-color: #2563eb;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.03), rgba(124, 58, 237, 0.03));
        }

        .plan-card.popular {
            border-color: #7c3aed;
        }

        .popular-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .plan-card-header {
            margin-bottom: 20px;
        }

        .plan-card-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .plan-card-header p {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }

        .plan-price {
            margin-bottom: 24px;
        }

        .plan-price .amount {
            font-size: 36px;
            font-weight: 800;
            color: #111827;
        }

        .plan-price .period {
            font-size: 14px;
            color: #6b7280;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 24px;
        }

        .plan-features li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 14px;
            color: #4b5563;
            padding: 8px 0;
        }

        .plan-features li svg {
            width: 18px;
            height: 18px;
            color: #2563eb;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .btn-plan {
            width: 100%;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-plan.primary {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: white;
        }

        .btn-plan.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-plan.current {
            background: #dcfce7;
            color: #166534;
            cursor: default;
        }

        .btn-plan.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-plan.secondary:hover {
            background: #e5e7eb;
        }

        /* Billing History */
        .billing-section {
            margin-top: 40px;
        }

        .billing-table {
            width: 100%;
            border-collapse: collapse;
        }

        .billing-table thead {
            background: #f9fafb;
        }

        .billing-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .billing-table th:last-child {
            text-align: right;
        }

        .billing-table td {
            padding: 16px;
            border-top: 1px solid #f3f4f6;
            font-size: 14px;
            color: #374151;
        }

        .billing-table td:last-child {
            text-align: right;
        }

        .billing-table tr:hover {
            background: #f9fafb;
        }

        .invoice-id {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #111827;
        }

        .invoice-id svg {
            width: 16px;
            height: 16px;
            color: #9ca3af;
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #2563eb;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .btn-download:hover {
            background: #eff6ff;
        }

        .btn-download svg {
            width: 14px;
            height: 14px;
        }

        .empty-invoices {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-invoices svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-invoices h4 {
            font-size: 15px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: #111827;
            color: white;
            border-radius: 10px;
            font-size: 14px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #059669;
        }

        .toast.error {
            background: #dc2626;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .billing-grid {
                grid-template-columns: 1fr;
            }

            .side-column {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            nav {
                padding: 0 20px;
            }

            .nav-links {
                display: none;
            }

            .main-content {
                padding: 20px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
            }

            .usage-stats {
                grid-template-columns: 1fr;
            }

            .billing-table {
                font-size: 13px;
            }

            .billing-table th,
            .billing-table td {
                padding: 12px 8px;
            }
        }

        /* Cancel Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-icon {
            width: 56px;
            height: 56px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .modal-icon svg {
            width: 28px;
            height: 28px;
            color: #dc2626;
        }

        .modal h3 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .modal p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-cancel {
            background: #f3f4f6;
            border: none;
            color: #374151;
        }

        .btn-modal-cancel:hover {
            background: #e5e7eb;
        }

        .btn-modal-confirm {
            background: #dc2626;
            border: none;
            color: white;
        }

        .btn-modal-confirm:hover {
            background: #b91c1c;
        }

        /* Payment Method Modal */
        .payment-modal {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 480px;
            width: 90%;
            text-align: left;
            transform: scale(0.95);
            transition: transform 0.3s;
            overflow: hidden;
        }

        .modal-overlay.active .payment-modal {
            transform: scale(1);
        }

        .payment-modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .payment-modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .payment-modal-header h3 .icon-wrapper {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-modal-header h3 svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .payment-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .payment-modal-close:hover {
            background: #e5e7eb;
        }

        .payment-modal-close svg {
            width: 18px;
            height: 18px;
            color: #6b7280;
        }

        .payment-modal-body {
            padding: 28px;
        }

        .payment-info-text {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .payment-form-group {
            margin-bottom: 20px;
        }

        .payment-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        /* Stripe Elements Styling */
        .stripe-element-container {
            padding: 14px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            transition: all 0.2s;
        }

        .stripe-element-container:focus-within {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .stripe-element-container.StripeElement--invalid {
            border-color: #dc2626;
        }

        .card-errors {
            color: #dc2626;
            font-size: 13px;
            margin-top: 8px;
            min-height: 20px;
        }

        .payment-modal-footer {
            padding: 20px 28px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
        }

        .btn-payment-cancel {
            flex: 1;
            padding: 14px 24px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-payment-cancel:hover {
            background: #f3f4f6;
        }

        .btn-payment-submit {
            flex: 2;
            padding: 14px 24px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-payment-submit:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-payment-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-payment-submit .spinner-small {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Card Preview */
        .card-preview {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .card-preview::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        .card-chip {
            width: 40px;
            height: 30px;
            background: linear-gradient(135deg, #d4af37 0%, #f5d060 50%, #d4af37 100%);
            border-radius: 4px;
            margin-bottom: 16px;
            position: relative;
        }

        .card-chip::before {
            content: '';
            position: absolute;
            left: 8px;
            right: 8px;
            top: 6px;
            bottom: 6px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        .card-number-preview {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            letter-spacing: 2px;
            margin-bottom: 16px;
            position: relative;
        }

        .card-bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
        }

        .card-holder-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .card-holder-name {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-expiry-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 2px;
            text-align: right;
        }

        .card-expiry-preview {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .secure-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
            margin-top: 16px;
        }

        .secure-badge svg {
            width: 14px;
            height: 14px;
            color: #10b981;
        }

        /* Billing Address Styles */
        .billing-address-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .billing-address-section .section-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .payment-form-row {
            display: flex;
            gap: 12px;
        }

        .payment-form-row .payment-form-group {
            margin-bottom: 12px;
        }

        .billing-address-section .payment-form-group {
            margin-bottom: 12px;
        }

        .billing-address-section input,
        .billing-address-section select {
            padding: 12px 14px;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .billing-address-section input:focus,
        .billing-address-section select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .billing-address-section select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="logo.png" alt="Dikoora">
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="design.html">Create</a></li>
                <li><a href="profile.html#designs">My Designs</a></li>
                <li><a href="features.html">Features</a></li>
                <li><a href="pricing.html">Pricing</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <a href="profile.html" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Profile
        </a>

        <div class="page-header">
            <h1>Subscription & Billing</h1>
            <p>Manage your plan, payment methods, and invoices.</p>
        </div>

        <div class="billing-grid">
            <!-- Main Column -->
            <div class="main-column">
                <!-- Current Plan Card -->
                <div class="card current-plan-card" id="currentPlanCard">
                    <div class="card-header">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            Current Plan
                        </h3>
                        <span class="status-badge active" id="planStatusBadge">Active</span>
                    </div>
                    <div class="card-body">
                        <div class="plan-details">
                            <div class="plan-info">
                                <h4>Plan</h4>
                                <div class="plan-name" id="currentPlanName">Pro</div>
                                <div class="plan-price" id="currentPlanPrice">$9.99 / month</div>
                            </div>
                            <div class="renewal-info" id="renewalInfo">
                                <h4>Renews on</h4>
                                <div class="renewal-date">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    <span id="renewalDate">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="plan-actions" id="planActions">
                            <button class="btn-cancel" onclick="showCancelModal()">Cancel Subscription</button>
                        </div>
                    </div>
                </div>

                <!-- Usage Analytics -->
                <div class="card">
                    <div class="card-header">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20V10M18 20V4M6 20v-4"/>
                            </svg>
                            Design Analytics
                        </h3>
                        <span style="font-size: 12px; color: #6b7280;">All Time</span>
                    </div>
                    <div class="card-body">
                        <p class="usage-description">Total room designs you've created with Dikoora.</p>

                        <div class="usage-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="totalDesigns">0</div>
                                <div class="stat-label">Total Designs</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="thisMonthDesigns">0</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="favoriteRoom">-</div>
                                <div class="stat-label">Favorite Room</div>
                            </div>
                        </div>

                        <div class="usage-chart" id="usageChart">
                            <div class="line-chart-container" id="lineChartContainer">
                                <!-- Line chart will be generated dynamically -->
                            </div>
                            <div class="chart-tooltip" id="chartTooltip">
                                <div class="tooltip-value" id="tooltipValue">0</div>
                                <div class="tooltip-label" id="tooltipLabel">designs</div>
                            </div>
                        </div>
                        <div class="chart-labels" id="chartLabels">
                            <!-- Labels will be generated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Side Column -->
            <div class="side-column">
                <!-- Payment Method -->
                <div class="card">
                    <div class="card-header">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                            Payment Method
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="paymentMethodContainer">
                            <div class="payment-method" id="paymentMethod" style="display: none;">
                                <div class="payment-left">
                                    <div class="card-icon">
                                        <svg width="24" height="16" viewBox="0 0 24 16" fill="none">
                                            <rect width="24" height="16" rx="2" fill="#1e293b"/>
                                            <rect y="4" width="24" height="3" fill="#475569"/>
                                            <rect x="2" y="10" width="8" height="2" rx="1" fill="#94a3b8"/>
                                        </svg>
                                    </div>
                                    <div class="card-details">
                                        <div class="card-brand" id="cardBrand">Visa **** 4242</div>
                                        <div class="card-expiry" id="cardExpiry">Expires 12/2025</div>
                                    </div>
                                </div>
                                <button class="btn-edit" onclick="updatePaymentMethod()">Edit</button>
                            </div>
                            <div id="noPaymentMethod">
                                <p style="color: #6b7280; font-size: 14px; text-align: center; padding: 20px;">No payment method on file</p>
                            </div>
                        </div>
                        <button class="btn-add-payment" onclick="addPaymentMethod()" id="addPaymentBtn">Add Payment Method</button>
                    </div>
                </div>

                <!-- Promo Card -->
                <div class="card promo-card">
                    <div class="card-body">
                        <h3>Need Help?</h3>
                        <p>Contact our support team for any questions about your subscription or billing.</p>
                        <a href="mailto:support@dikoora.com" class="btn-contact">Contact Support</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Plans -->
        <div class="plans-section">
            <div class="section-header">
                <h2>Available Plans</h2>
            </div>

            <div class="plans-grid">
                <!-- Free Plan -->
                <div class="plan-card" id="freePlanCard">
                    <div class="plan-card-header">
                        <h3>Free</h3>
                        <p>Perfect for trying out Dikoora</p>
                    </div>
                    <div class="plan-price">
                        <span class="amount">$0</span>
                        <span class="period">/ month</span>
                    </div>
                    <ul class="plan-features">
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            3 room designs total
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Basic resolution exports
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Community support
                        </li>
                    </ul>
                    <button class="btn-plan secondary" id="freePlanBtn" onclick="selectPlan('free')">Current Plan</button>
                </div>

                <!-- Pro Plan -->
                <div class="plan-card popular" id="proPlanCard">
                    <div class="popular-badge">Most Popular</div>
                    <div class="plan-card-header">
                        <h3>Pro</h3>
                        <p>For design enthusiasts and professionals</p>
                    </div>
                    <div class="plan-price">
                        <span class="amount">$9.99</span>
                        <span class="period">/ month</span>
                    </div>
                    <ul class="plan-features">
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Unlimited room designs
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            High-resolution exports
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Save & access all designs
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Priority support
                        </li>
                    </ul>
                    <button class="btn-plan primary" id="proPlanBtn" onclick="selectPlan('pro')">Upgrade to Pro</button>
                </div>
            </div>
        </div>

        <!-- Billing History -->
        <div class="billing-section">
            <div class="section-header">
                <h2>Billing History</h2>
            </div>

            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <table class="billing-table" id="billingTable">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesBody">
                            <!-- Invoices will be loaded here -->
                        </tbody>
                    </table>
                    <div id="emptyInvoices" class="empty-invoices" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <h4>No invoices yet</h4>
                        <p>Your billing history will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Subscription Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <h3>Cancel Subscription?</h3>
            <p>Your Pro benefits will remain active until the end of your current billing period. After that, your account will be downgraded to the Free plan.</p>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeCancelModal()">Keep Subscription</button>
                <button class="btn-modal-confirm" onclick="confirmCancelSubscription()">Cancel Subscription</button>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="payment-modal">
            <div class="payment-modal-header">
                <h3>
                    <span class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                            <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                    </span>
                    Update Payment Method
                </h3>
                <button class="payment-modal-close" onclick="closePaymentModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="payment-modal-body">
                <p class="payment-info-text">Enter your new card details below. Your card will be securely saved for future payments.</p>

                <!-- Card Preview -->
                <div class="card-preview">
                    <div class="card-chip"></div>
                    <div class="card-number-preview" id="cardNumberPreview">**** **** **** ****</div>
                    <div class="card-bottom-row">
                        <div>
                            <div class="card-holder-label">Card Holder</div>
                            <div class="card-holder-name" id="cardHolderPreview">Your Name</div>
                        </div>
                        <div>
                            <div class="card-expiry-label">Expires</div>
                            <div class="card-expiry-preview" id="cardExpiryPreview">MM/YY</div>
                        </div>
                    </div>
                </div>

                <form id="paymentForm">
                    <div class="payment-form-group">
                        <label for="cardholderName">Cardholder Name</label>
                        <input type="text" id="cardholderName" class="stripe-element-container" placeholder="Name on card" style="width: 100%; font-size: 16px; border: 1px solid #e5e7eb; outline: none;">
                    </div>

                    <div class="payment-form-group">
                        <label>Card Details</label>
                        <div id="card-element" class="stripe-element-container">
                            <!-- Stripe Card Element will be mounted here -->
                        </div>
                        <div id="card-errors" class="card-errors" role="alert"></div>
                    </div>

                    <!-- Billing Address Section -->
                    <div class="billing-address-section">
                        <label class="section-label">Billing Address</label>

                        <div class="payment-form-group">
                            <input type="text" id="billingAddress" class="stripe-element-container" placeholder="Street address" style="width: 100%; font-size: 16px; border: 1px solid #e5e7eb; outline: none;">
                        </div>

                        <div class="payment-form-row">
                            <div class="payment-form-group" style="flex: 1;">
                                <input type="text" id="billingCity" class="stripe-element-container" placeholder="City" style="width: 100%; font-size: 16px; border: 1px solid #e5e7eb; outline: none;">
                            </div>
                            <div class="payment-form-group" style="flex: 1;">
                                <input type="text" id="billingState" class="stripe-element-container" placeholder="State/Province" style="width: 100%; font-size: 16px; border: 1px solid #e5e7eb; outline: none;">
                            </div>
                        </div>

                        <div class="payment-form-row">
                            <div class="payment-form-group" style="flex: 1;">
                                <input type="text" id="billingPostal" class="stripe-element-container" placeholder="Postal code" style="width: 100%; font-size: 16px; border: 1px solid #e5e7eb; outline: none;">
                            </div>
                            <div class="payment-form-group" style="flex: 1;">
                                <select id="billingCountry" class="stripe-element-container" style="width: 100%; font-size: 16px; border: 1px solid #e5e7eb; outline: none; background: white;">
                                    <option value="">Select Country</option>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                    <option value="DE">Germany</option>
                                    <option value="FR">France</option>
                                    <option value="ES">Spain</option>
                                    <option value="IT">Italy</option>
                                    <option value="NL">Netherlands</option>
                                    <option value="BE">Belgium</option>
                                    <option value="AT">Austria</option>
                                    <option value="CH">Switzerland</option>
                                    <option value="SE">Sweden</option>
                                    <option value="NO">Norway</option>
                                    <option value="DK">Denmark</option>
                                    <option value="FI">Finland</option>
                                    <option value="IE">Ireland</option>
                                    <option value="PT">Portugal</option>
                                    <option value="NZ">New Zealand</option>
                                    <option value="SG">Singapore</option>
                                    <option value="JP">Japan</option>
                                    <option value="IN">India</option>
                                    <option value="BR">Brazil</option>
                                    <option value="MX">Mexico</option>
                                    <option value="AE">United Arab Emirates</option>
                                    <option value="SA">Saudi Arabia</option>
                                    <option value="ZA">South Africa</option>
                                    <option value="PL">Poland</option>
                                    <option value="CZ">Czech Republic</option>
                                    <option value="HU">Hungary</option>
                                    <option value="RO">Romania</option>
                                    <option value="GR">Greece</option>
                                    <option value="IL">Israel</option>
                                    <option value="TH">Thailand</option>
                                    <option value="MY">Malaysia</option>
                                    <option value="PH">Philippines</option>
                                    <option value="ID">Indonesia</option>
                                    <option value="VN">Vietnam</option>
                                    <option value="KR">South Korea</option>
                                    <option value="TW">Taiwan</option>
                                    <option value="HK">Hong Kong</option>
                                    <option value="AR">Argentina</option>
                                    <option value="CL">Chile</option>
                                    <option value="CO">Colombia</option>
                                    <option value="PE">Peru</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="secure-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0110 0v4"/>
                        </svg>
                        Secured by Stripe. Your card details are encrypted.
                    </div>
                </form>
            </div>
            <div class="payment-modal-footer">
                <button class="btn-payment-cancel" onclick="closePaymentModal()">Cancel</button>
                <button class="btn-payment-submit" id="submitPaymentBtn" onclick="submitPaymentMethod()">
                    <span id="submitBtnText">Save Card</span>
                    <div class="spinner-small" id="submitSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <script>
        let currentUser = null;
        let currentPlan = 'free';
        let subscriptionStatus = 'inactive';
        let stripeCustomerId = null;

        // Stripe Elements variables
        let stripe = null;
        let cardElement = null;
        let setupIntentClientSecret = null;

        async function initSubscription() {
            if (!initSupabase()) {
                showToast('Failed to initialize. Please refresh.', 'error');
                return;
            }

            currentUser = await getUser();

            if (!currentUser) {
                window.location.href = 'design.html';
                return;
            }

            await loadSubscriptionData();
            await loadDesignAnalytics();
            await loadBillingHistory();

            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        async function loadSubscriptionData() {
            try {
                const { data: profile, error } = await getProfile(currentUser.id);

                if (error) {
                    console.error('Error loading profile:', error);
                    return;
                }

                currentPlan = profile?.subscription_plan || 'free';
                subscriptionStatus = profile?.subscription_status || 'inactive';
                stripeCustomerId = profile?.stripe_customer_id;

                updatePlanDisplay(profile);
                updatePlanButtons();
                updatePaymentMethodDisplay(profile);
            } catch (error) {
                console.error('Error loading subscription:', error);
            }
        }

        function updatePlanDisplay(profile) {
            const planCard = document.getElementById('currentPlanCard');
            const planName = document.getElementById('currentPlanName');
            const planPrice = document.getElementById('currentPlanPrice');
            const statusBadge = document.getElementById('planStatusBadge');
            const renewalInfo = document.getElementById('renewalInfo');
            const planActions = document.getElementById('planActions');

            if (currentPlan === 'free' || subscriptionStatus !== 'active') {
                planCard.classList.add('free');
                planName.textContent = 'Free';
                planPrice.textContent = '$0 / month';
                statusBadge.textContent = 'Free';
                statusBadge.className = 'status-badge inactive';
                renewalInfo.style.display = 'none';
                planActions.style.display = 'none';
            } else {
                planCard.classList.remove('free');
                planName.textContent = 'Pro';
                planPrice.textContent = '$9.99 / month';
                statusBadge.textContent = 'Active';
                statusBadge.className = 'status-badge active';
                renewalInfo.style.display = 'block';
                planActions.style.display = 'flex';

                // Set renewal date (mock for now - would come from Stripe)
                const renewalDate = new Date();
                renewalDate.setMonth(renewalDate.getMonth() + 1);
                document.getElementById('renewalDate').textContent = renewalDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
        }

        function updatePlanButtons() {
            const freePlanCard = document.getElementById('freePlanCard');
            const proPlanCard = document.getElementById('proPlanCard');
            const freePlanBtn = document.getElementById('freePlanBtn');
            const proPlanBtn = document.getElementById('proPlanBtn');

            if (currentPlan === 'pro' && subscriptionStatus === 'active') {
                freePlanCard.classList.remove('current');
                proPlanCard.classList.add('current');
                freePlanBtn.className = 'btn-plan secondary';
                freePlanBtn.textContent = 'Downgrade';
                proPlanBtn.className = 'btn-plan current';
                proPlanBtn.textContent = 'Current Plan';
                proPlanBtn.disabled = true;
            } else {
                freePlanCard.classList.add('current');
                proPlanCard.classList.remove('current');
                freePlanBtn.className = 'btn-plan current';
                freePlanBtn.textContent = 'Current Plan';
                freePlanBtn.disabled = true;
                proPlanBtn.className = 'btn-plan primary';
                proPlanBtn.textContent = 'Upgrade to Pro';
                proPlanBtn.disabled = false;
            }
        }

        async function updatePaymentMethodDisplay(profile) {
            const paymentMethodEl = document.getElementById('paymentMethod');
            const noPaymentMethod = document.getElementById('noPaymentMethod');
            const addPaymentBtn = document.getElementById('addPaymentBtn');

            if (stripeCustomerId) {
                try {
                    // Fetch actual payment method from Stripe
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) return;

                    const response = await fetch('/api/payment-method', {
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`
                        }
                    });

                    const data = await response.json();

                    if (data.paymentMethod) {
                        paymentMethodEl.style.display = 'flex';
                        noPaymentMethod.style.display = 'none';
                        addPaymentBtn.textContent = 'Update Payment Method';

                        // Display actual card info from Stripe
                        const pm = data.paymentMethod;
                        const brandDisplay = pm.brand ? pm.brand.charAt(0).toUpperCase() + pm.brand.slice(1) : 'Card';
                        document.getElementById('cardBrand').textContent = `${brandDisplay} **** ${pm.last4}`;
                        document.getElementById('cardExpiry').textContent = `Expires ${pm.exp_month}/${pm.exp_year}`;
                    } else {
                        paymentMethodEl.style.display = 'none';
                        noPaymentMethod.style.display = 'block';
                        addPaymentBtn.textContent = 'Add Payment Method';
                    }
                } catch (error) {
                    console.error('Error fetching payment method:', error);
                    paymentMethodEl.style.display = 'none';
                    noPaymentMethod.style.display = 'block';
                    addPaymentBtn.textContent = 'Add Payment Method';
                }
            } else {
                paymentMethodEl.style.display = 'none';
                noPaymentMethod.style.display = 'block';
                addPaymentBtn.textContent = 'Add Payment Method';
            }
        }

        async function loadDesignAnalytics() {
            try {
                const { data: designs, error } = await getUserDesigns(currentUser.id);

                if (error) {
                    console.error('Error loading designs:', error);
                    return;
                }

                const totalDesigns = designs?.length || 0;
                document.getElementById('totalDesigns').textContent = totalDesigns;

                // Calculate this month's designs
                const now = new Date();
                const thisMonthDesigns = designs?.filter(d => {
                    const created = new Date(d.created_at);
                    return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
                }).length || 0;
                document.getElementById('thisMonthDesigns').textContent = thisMonthDesigns;

                // Find favorite room type
                if (designs && designs.length > 0) {
                    const roomCounts = {};
                    designs.forEach(d => {
                        const room = d.room_type || 'unknown';
                        roomCounts[room] = (roomCounts[room] || 0) + 1;
                    });
                    const favoriteRoom = Object.entries(roomCounts).sort((a, b) => b[1] - a[1])[0];
                    if (favoriteRoom) {
                        const roomName = favoriteRoom[0].split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                        document.getElementById('favoriteRoom').textContent = roomName;
                    }
                }

                // Generate chart
                generateDesignChart(designs || []);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function generateDesignChart(designs) {
            const chartContainer = document.getElementById('lineChartContainer');
            const chartLabels = document.getElementById('chartLabels');
            const tooltip = document.getElementById('chartTooltip');
            const tooltipValue = document.getElementById('tooltipValue');
            const tooltipLabel = document.getElementById('tooltipLabel');

            // Get last 6 months of data
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    fullMonth: date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                    year: date.getFullYear(),
                    monthNum: date.getMonth(),
                    yearNum: date.getFullYear(),
                    count: 0
                });
            }

            // Count designs per month
            designs.forEach(d => {
                const created = new Date(d.created_at);
                const monthData = months.find(m =>
                    m.monthNum === created.getMonth() && m.yearNum === created.getFullYear()
                );
                if (monthData) {
                    monthData.count++;
                }
            });

            // Find max for scaling (minimum 5 for better visualization)
            const maxCount = Math.max(...months.map(m => m.count), 5);
            const chartHeight = 160;
            const chartWidth = chartContainer.offsetWidth || 400;
            const padding = { top: 10, right: 10, bottom: 10, left: 10 };
            const innerWidth = chartWidth - padding.left - padding.right;
            const innerHeight = chartHeight - padding.top - padding.bottom;

            // Calculate points
            const points = months.map((m, i) => ({
                x: padding.left + (i / (months.length - 1)) * innerWidth,
                y: padding.top + innerHeight - (m.count / maxCount) * innerHeight,
                data: m
            }));

            // Create smooth curve path using Catmull-Rom spline
            function catmullRomSpline(points, tension = 0.5) {
                if (points.length < 2) return '';

                let path = `M ${points[0].x},${points[0].y}`;

                for (let i = 0; i < points.length - 1; i++) {
                    const p0 = points[Math.max(i - 1, 0)];
                    const p1 = points[i];
                    const p2 = points[i + 1];
                    const p3 = points[Math.min(i + 2, points.length - 1)];

                    const cp1x = p1.x + (p2.x - p0.x) / 6 * tension;
                    const cp1y = p1.y + (p2.y - p0.y) / 6 * tension;
                    const cp2x = p2.x - (p3.x - p1.x) / 6 * tension;
                    const cp2y = p2.y - (p3.y - p1.y) / 6 * tension;

                    path += ` C ${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`;
                }

                return path;
            }

            // Create area path
            function createAreaPath(linePath) {
                const firstPoint = points[0];
                const lastPoint = points[points.length - 1];
                return `${linePath} L ${lastPoint.x},${chartHeight - padding.bottom} L ${firstPoint.x},${chartHeight - padding.bottom} Z`;
            }

            const linePath = catmullRomSpline(points, 1);
            const areaPath = createAreaPath(linePath);

            // Generate SVG
            const svgContent = `
                <svg class="line-chart-svg" viewBox="0 0 ${chartWidth} ${chartHeight}" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#2563eb"/>
                            <stop offset="100%" style="stop-color:#7c3aed"/>
                        </linearGradient>
                        <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#2563eb;stop-opacity:0.3"/>
                            <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:0.05"/>
                        </linearGradient>
                    </defs>

                    <!-- Grid lines -->
                    ${[0, 0.25, 0.5, 0.75, 1].map(ratio => {
                        const y = padding.top + (1 - ratio) * innerHeight;
                        return `<line class="chart-grid-line" x1="${padding.left}" y1="${y}" x2="${chartWidth - padding.right}" y2="${y}"/>`;
                    }).join('')}

                    <!-- Area fill -->
                    <path class="chart-area" d="${areaPath}"/>

                    <!-- Line -->
                    <path class="chart-line" d="${linePath}"/>

                    <!-- Data points with hit areas -->
                    ${points.map((p, i) => `
                        <g class="chart-point-group" data-index="${i}">
                            <circle class="chart-point-hitarea" cx="${p.x}" cy="${p.y}" r="20"/>
                            <circle class="chart-point" cx="${p.x}" cy="${p.y}" r="6" data-index="${i}"/>
                        </g>
                    `).join('')}
                </svg>
            `;

            chartContainer.innerHTML = svgContent;

            // Add hover interactions
            const pointGroups = chartContainer.querySelectorAll('.chart-point-group');
            const chartRect = chartContainer.getBoundingClientRect();

            pointGroups.forEach((group, index) => {
                const point = points[index];
                const monthData = point.data;

                group.addEventListener('mouseenter', (e) => {
                    tooltipValue.textContent = monthData.count;
                    tooltipLabel.textContent = `designs in ${monthData.fullMonth}`;

                    // Position tooltip
                    const pointRect = group.querySelector('.chart-point').getBoundingClientRect();
                    const containerRect = chartContainer.parentElement.getBoundingClientRect();

                    tooltip.style.left = `${point.x + padding.left}px`;
                    tooltip.style.top = `${point.y - 15}px`;
                    tooltip.classList.add('visible');
                });

                group.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });

            // Generate labels
            chartLabels.innerHTML = months.map(m => `<span>${m.month}</span>`).join('');

            // Show empty state if no designs
            if (designs.length === 0) {
                chartContainer.innerHTML = `
                    <div class="chart-empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 20V10M18 20V4M6 20v-4"/>
                        </svg>
                        <p>No design activity yet</p>
                    </div>
                `;
            }
        }

        async function loadBillingHistory() {
            const invoicesBody = document.getElementById('invoicesBody');
            const emptyInvoices = document.getElementById('emptyInvoices');
            const billingTable = document.getElementById('billingTable');

            if (!stripeCustomerId || subscriptionStatus !== 'active') {
                billingTable.style.display = 'none';
                emptyInvoices.style.display = 'block';
                return;
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const response = await fetch('/api/billing-history', {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch billing history');
                }

                const data = await response.json();

                if (!data.invoices || data.invoices.length === 0) {
                    billingTable.style.display = 'none';
                    emptyInvoices.style.display = 'block';
                    return;
                }

                billingTable.style.display = 'table';
                emptyInvoices.style.display = 'none';

                invoicesBody.innerHTML = data.invoices.map(invoice => `
                    <tr>
                        <td>
                            <div class="invoice-id">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                </svg>
                                ${invoice.number || invoice.id}
                            </div>
                        </td>
                        <td>${new Date(invoice.created * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td>
                            <span class="status-badge ${invoice.status === 'paid' ? 'active' : 'inactive'}">
                                ${invoice.status}
                            </span>
                        </td>
                        <td>$${(invoice.amount_paid / 100).toFixed(2)}</td>
                        <td>
                            ${invoice.invoice_pdf ? `
                                <a href="${invoice.invoice_pdf}" target="_blank" class="btn-download">
                                    PDF
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7,10 12,15 17,10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                </a>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading billing history:', error);
                billingTable.style.display = 'none';
                emptyInvoices.style.display = 'block';
            }
        }

        async function selectPlan(plan) {
            if (plan === 'pro') {
                // Redirect to pricing page for checkout
                window.location.href = 'pricing.html';
            } else if (plan === 'free') {
                // Show cancel modal for downgrade
                showCancelModal();
            }
        }

        function showCancelModal() {
            document.getElementById('cancelModal').classList.add('active');
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('active');
        }

        async function confirmCancelSubscription() {
            const confirmBtn = document.querySelector('.btn-modal-confirm');
            confirmBtn.textContent = 'Canceling...';
            confirmBtn.disabled = true;

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error('Not authenticated');

                const response = await fetch('/api/cancel-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to cancel subscription');
                }

                showToast('Subscription canceled. You will retain Pro access until the end of your billing period.', 'success');
                closeCancelModal();

                // Reload the page to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Cancel error:', error);
                showToast(error.message || 'Failed to cancel subscription', 'error');
                confirmBtn.textContent = 'Cancel Subscription';
                confirmBtn.disabled = false;
            }
        }

        // Show payment modal
        async function showPaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('active');

            // Reset form
            document.getElementById('cardholderName').value = '';
            document.getElementById('card-errors').textContent = '';
            document.getElementById('cardNumberPreview').textContent = '**** **** **** ****';
            document.getElementById('cardHolderPreview').textContent = 'YOUR NAME';
            document.getElementById('cardExpiryPreview').textContent = 'MM/YY';

            // Reset billing address fields
            document.getElementById('billingAddress').value = '';
            document.getElementById('billingCity').value = '';
            document.getElementById('billingState').value = '';
            document.getElementById('billingPostal').value = '';
            document.getElementById('billingCountry').value = '';

            // Initialize Stripe if not already
            if (!stripe) {
                await initializeStripeElements();
            } else if (cardElement) {
                cardElement.clear();
            }
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.remove('active');
        }

        // Initialize Stripe Elements
        async function initializeStripeElements() {
            try {
                // Fetch publishable key from server
                const configResponse = await fetch('/api/stripe-config');
                const config = await configResponse.json();

                if (!config.publishableKey) {
                    throw new Error('Stripe publishable key not configured');
                }

                stripe = Stripe(config.publishableKey);
                const elements = stripe.elements();

                // Create card element with custom styling
                const style = {
                    base: {
                        fontSize: '16px',
                        color: '#1a1a2e',
                        fontFamily: "'Plus Jakarta Sans', sans-serif",
                        '::placeholder': {
                            color: '#9ca3af'
                        }
                    },
                    invalid: {
                        color: '#dc2626',
                        iconColor: '#dc2626'
                    }
                };

                cardElement = elements.create('card', {
                    style,
                    hidePostalCode: true
                });

                cardElement.mount('#card-element');

                // Listen for changes
                cardElement.on('change', function(event) {
                    const errorElement = document.getElementById('card-errors');
                    if (event.error) {
                        errorElement.textContent = event.error.message;
                    } else {
                        errorElement.textContent = '';
                    }

                    // Update card preview
                    if (event.brand && event.brand !== 'unknown') {
                        updateCardBrandPreview(event.brand);
                    }
                });

                // Update cardholder name preview
                document.getElementById('cardholderName').addEventListener('input', function(e) {
                    const name = e.target.value.toUpperCase() || 'YOUR NAME';
                    document.getElementById('cardHolderPreview').textContent = name;
                });

            } catch (error) {
                console.error('Error initializing Stripe:', error);
                showToast('Failed to initialize payment form', 'error');
            }
        }

        function updateCardBrandPreview(brand) {
            // Update card preview based on brand
            const brandDisplay = {
                'visa': 'VISA',
                'mastercard': 'MC',
                'amex': 'AMEX',
                'discover': 'DISC',
                'diners': 'DINE',
                'jcb': 'JCB',
                'unionpay': 'UP'
            };
            console.log('Card brand:', brand, brandDisplay[brand] || brand.toUpperCase());
        }

        async function addPaymentMethod() {
            await showPaymentModal();
        }

        async function updatePaymentMethod() {
            await showPaymentModal();
        }

        async function submitPaymentMethod() {
            const submitBtn = document.getElementById('submitPaymentBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitSpinner = document.getElementById('submitSpinner');
            const cardholderName = document.getElementById('cardholderName').value.trim();

            // Get billing address fields
            const billingAddress = document.getElementById('billingAddress').value.trim();
            const billingCity = document.getElementById('billingCity').value.trim();
            const billingState = document.getElementById('billingState').value.trim();
            const billingPostal = document.getElementById('billingPostal').value.trim();
            const billingCountry = document.getElementById('billingCountry').value;

            // Validate required fields
            if (!cardholderName) {
                document.getElementById('card-errors').textContent = 'Please enter the cardholder name';
                return;
            }

            if (!billingAddress || !billingCity || !billingPostal || !billingCountry) {
                document.getElementById('card-errors').textContent = 'Please fill in all required billing address fields';
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtnText.textContent = 'Saving...';
            submitSpinner.style.display = 'block';

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error('Not authenticated');

                // Create setup intent
                const setupResponse = await fetch('/api/create-setup-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                const setupData = await setupResponse.json();

                if (!setupResponse.ok) {
                    throw new Error(setupData.error || 'Failed to create setup intent');
                }

                // Confirm the setup with the card element and billing address
                const { setupIntent, error } = await stripe.confirmCardSetup(setupData.clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: cardholderName,
                            address: {
                                line1: billingAddress,
                                city: billingCity,
                                state: billingState,
                                postal_code: billingPostal,
                                country: billingCountry
                            }
                        }
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Set as default payment method
                const updateResponse = await fetch('/api/update-default-payment-method', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        paymentMethodId: setupIntent.payment_method
                    })
                });

                const updateData = await updateResponse.json();

                if (!updateResponse.ok) {
                    throw new Error(updateData.error || 'Failed to update payment method');
                }

                showToast('Payment method updated successfully!', 'success');
                closePaymentModal();

                // Reload the page to show updated payment info
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (error) {
                console.error('Payment method error:', error);
                document.getElementById('card-errors').textContent = error.message;
                showToast(error.message || 'Failed to update payment method', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Save Card';
                submitSpinner.style.display = 'none';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Initialize on load
        initSubscription();
    </script>
</body>
</html>
